<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบยืนยันตัวตนบุคลากร</title>

    <script
      charset="utf-8"
      src="https://static.line-scdn.net/liff/edge/2/sdk.js"
    ></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Mali", cursive;
        /* ธีมสีพื้นหลังแบบ Gradient สดใส (ฟ้า-ชมพูอ่อน) */
        background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-custom {
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: none;
      }

      .profile-img {
        width: 110px;
        height: 110px;
        border-radius: 50%;
        border: 4px solid #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        object-fit: cover;
      }

      /* ปรับแต่ง Dropdown และ Button ให้ขอบมนดูทันสมัย */
      .form-select,
      .btn {
        border-radius: 50rem;
      }

      /* หน้าต่าง Loading แบบเต็มจอ */
      #global-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease;
      }

      .footer-text {
        font-size: 0.8rem;
        color: #6c757d;
      }
    </style>
  </head>
  <body class="p-3">
    <div id="global-loader">
      <div
        class="spinner-grow text-primary mb-3"
        style="width: 3rem; height: 3rem"
        role="status"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4 class="text-primary fw-bold">กำลังเตรียมข้อมูล...</h4>
      <p class="text-muted">กรุณารอสักครู่</p>
    </div>

    <div class="container" style="max-width: 500px">
      <div class="card card-custom p-4 p-md-5 text-center">
        <div id="profileSection" class="mb-4 d-none">
          <img
            id="pictureUrl"
            class="profile-img mb-3"
            src=""
            alt="Profile Picture"
          />
          <h4 id="displayName" class="fw-bold text-dark mb-0">สวัสดี!</h4>
          <h6 id="userId" class="fw-bold text-dark mb-0">userId</h6>
        </div>

        <div id="successSection" class="d-none">
          <div
            class="alert alert-success rounded-4 text-start shadow-sm border-0"
            role="alert"
          >
            <h5 class="alert-heading fw-bold text-success mb-3 text-center">
              <i class="bi bi-check-circle-fill fs-2 d-block mb-2"></i>
              คุณได้ยืนยันตัวตนแล้ว
            </h5>
            <hr />
            <p class="mb-2">
              <i class="bi bi-person-badge me-2"></i><strong>ชื่อ:</strong>
              <span id="resName" class="text-dark"></span>
            </p>
            <p class="mb-0">
              <i class="bi bi-building me-2"></i><strong>กลุ่มงาน:</strong>
              <span id="resDept" class="text-dark"></span>
            </p>
          </div>
          <button
            class="btn btn-outline-success btn-lg w-100 mt-3"
            onclick="liff.closeWindow()"
          >
            ปิดหน้าต่าง
          </button>
        </div>

        <div id="formSection" class="text-start d-none">
          <p class="text-center text-muted mb-4">
            กรุณาระบุข้อมูลเพื่อผูกบัญชี LINE
          </p>

          <div class="mb-3">
            <label
              for="departmentSelect"
              class="form-label fw-bold text-primary"
              >1. เลือกกลุ่มงาน/แผนก</label
            >
            <select
              id="departmentSelect"
              class="form-select form-select-lg shadow-sm"
              onchange="filterEmployees()"
            >
              <option value="">-- กำลังโหลดข้อมูล... --</option>
            </select>
          </div>

          <div class="mb-4">
            <label for="employeeSelect" class="form-label fw-bold text-primary"
              >2. เลือกชื่อ-นามสกุล</label
            >
            <select
              id="employeeSelect"
              class="form-select form-select-lg shadow-sm"
              disabled
            >
              <option value="">-- กรุณาเลือกแผนกก่อน --</option>
            </select>
          </div>

          <button
            id="submitBtn"
            class="btn btn-primary btn-lg w-100 fw-bold shadow"
            onclick="confirmIdentity()"
            disabled
          >
            <i class="bi bi-person-check-fill me-1"></i> ยืนยันตัวตน
          </button>
        </div>

        <div class="mt-5 pt-3 border-top footer-text">
          <strong class="text-dark">สำนักงานสาธารณสุขจังหวัดลพบุรี</strong>
          <div class="mt-2 text-muted" style="font-size: 0.75rem">
            ©2026 ออกแบบโดย นายวุฒิพงษ์ เอี่ยมชื่น<br />นักวิชาการคอมพิวเตอร์ปฏิบัติการ
          </div>
        </div>
      </div>
    </div>

    <script>
      const LIFF_ID = "2008916930-hH84U2jI"; // ใส่ LIFF ID
      const GAS_WEBAPP_URL =
        "https://script.google.com/macros/s/AKfycbzNCJIwFtptUa4Fo6NT5u4Dxpc2RtB1UTzGCs-GJXeOzilc_l3IMtzWRdgCJ-63mv0Acw/exec"; // นำ URL ที่คัดลอกไว้มาใส่ตรงนี้

      let currentUserId = "";
      let allEmployees = [];

      async function initializeLiff() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            currentUserId = profile.userId;

            document.getElementById("pictureUrl").src = profile.pictureUrl;
            document.getElementById("userId").innerText = profile.currentUserId;
            document.getElementById("displayName").innerText =
              "สวัสดีคุณ " + profile.displayName;
            document
              .getElementById("profileSection")
              .classList.remove("d-none");

            // เรียกเช็คข้อมูลและดึงรายชื่อ
            fetchEmployeeData();
          } else {
            liff.login();
          }
        } catch (err) {
          console.error("LIFF Init failed", err);
          document.getElementById("displayName").innerText =
            "เกิดข้อผิดพลาดในการเชื่อมต่อ LINE";
        }
      }

      async function fetchEmployeeData() {
        try {
          const response = await fetch(
            `${GAS_WEBAPP_URL}?userId=${currentUserId}`,
          );
          const result = await response.json();

          // ปิดหน้าโหลดดิ้งแบบเต็มจอ
          hideGlobalLoader();

          if (result.isRegistered) {
            // แสดงหน้า Success
            document.getElementById("resName").innerText = result.name;
            document.getElementById("resDept").innerText = result.department;
            document.getElementById("resUserId").innerText = result.userId;
            document
              .getElementById("successSection")
              .classList.remove("d-none");
          } else {
            // โหลดรายชื่อลงฟอร์ม
            allEmployees = result.employees;
            const deptSelect = document.getElementById("departmentSelect");

            if (allEmployees.length === 0) {
              deptSelect.innerHTML =
                '<option value="">ไม่พบรายชื่อที่รอการยืนยัน</option>';
              deptSelect.disabled = true;
            } else {
              const departments = [
                ...new Set(allEmployees.map((emp) => emp.department)),
              ];
              deptSelect.innerHTML =
                '<option value="">-- เลือกกลุ่มงาน/แผนก --</option>';
              departments.forEach((dept) => {
                let option = document.createElement("option");
                option.value = dept;
                option.text = dept;
                deptSelect.add(option);
              });
            }

            document.getElementById("formSection").classList.remove("d-none");
          }
        } catch (err) {
          console.error("Fetch error", err);
          hideGlobalLoader();
          alert("ไม่สามารถดึงข้อมูลจากระบบได้");
        }
      }

      function filterEmployees() {
        const selectedDept = document.getElementById("departmentSelect").value;
        const empSelect = document.getElementById("employeeSelect");
        const submitBtn = document.getElementById("submitBtn");

        empSelect.innerHTML = '<option value="">-- เลือกชื่อของคุณ --</option>';

        if (!selectedDept) {
          empSelect.disabled = true;
          submitBtn.disabled = true;
          return;
        }

        const filteredEmps = allEmployees.filter(
          (emp) => emp.department === selectedDept,
        );

        filteredEmps.forEach((emp) => {
          let option = document.createElement("option");
          option.value = emp.id;
          option.text = emp.name;
          empSelect.add(option);
        });

        empSelect.disabled = false;
        submitBtn.disabled = false;
      }

      async function confirmIdentity() {
        const selectedEmpId = document.getElementById("employeeSelect").value;
        if (!selectedEmpId) {
          alert("กรุณาเลือกชื่อของคุณ");
          return;
        }

        // เปลี่ยนสถานะปุ่มเป็น Loading
        const submitBtn = document.getElementById("submitBtn");
        const originalBtnHtml = submitBtn.innerHTML;
        submitBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>กำลังบันทึกข้อมูล...';
        submitBtn.disabled = true;

        try {
          const response = await fetch(GAS_WEBAPP_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({
              userId: currentUserId,
              empId: selectedEmpId,
            }),
          });

          const result = await response.json();

          if (result.status === "success") {
            // เปิด Loader เต็มจออีกครั้งเพื่อดึงข้อมูลใหม่มาแสดงความสำเร็จ
            showGlobalLoader("บันทึกสำเร็จ! กำลังอัปเดตข้อมูล...");
            document.getElementById("formSection").classList.add("d-none");
            fetchEmployeeData();
          } else {
            alert("เกิดข้อผิดพลาด: " + result.message);
            resetSubmitButton(submitBtn, originalBtnHtml);
          }
        } catch (error) {
          console.error("Submit error:", error);
          alert("ไม่สามารถเชื่อมต่อระบบฐานข้อมูลได้");
          resetSubmitButton(submitBtn, originalBtnHtml);
        }
      }

      function resetButton() {
        document.getElementById("submitBtn").style.display = "block";
        document.getElementById("loading").style.display = "none";
      }

      // --- Helper Functions ---
      function hideGlobalLoader() {
        const loader = document.getElementById("global-loader");
        loader.style.opacity = "0";
        setTimeout(() => (loader.style.display = "none"), 500);
      }

      function showGlobalLoader(text = "กำลังโหลดข้อมูล...") {
        const loader = document.getElementById("global-loader");
        loader.querySelector("h4").innerText = text;
        loader.style.display = "flex";
        setTimeout(() => (loader.style.opacity = "1"), 10);
      }

      window.onload = function () {
        initializeLiff();
      };
    </script>
  </body>
</html>
